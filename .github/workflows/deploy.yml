# Haven Institute - GitHub Actions CI/CD for Hetzner
# Auto-deploys on push to main branch

name: Deploy to Hetzner

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger option

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Hetzner VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            cd ~/apps/Haveninstitute
            
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ğŸ—‘ï¸ Cleaning up unnecessary files on server..."
            # Remove documentation files
            rm -f *.md 2>/dev/null || true
            rm -f *.sql 2>/dev/null || true
            rm -f gen-hash.js register-admin.json 2>/dev/null || true
            rm -f .env.docker .env.staging .env.production.example 2>/dev/null || true
            rm -rf src/*.md src/guidelines 2>/dev/null || true
            rm -f backend/*.md 2>/dev/null || true
            rm -f backend/.env.production.example backend/.env.staging 2>/dev/null || true
            # Keep only README.md
            echo "âœ“ Server files cleaned"
            
            echo "ğŸ”§ Ensuring production configuration..."
            if [ -f backend/.env.production ]; then
              # Update CORS_ORIGIN
              if grep -q "^CORS_ORIGIN=" backend/.env.production; then
                sed -i 's|^CORS_ORIGIN=.*|CORS_ORIGIN=https://havenstudy.com,https://www.havenstudy.com|' backend/.env.production
              else
                echo "CORS_ORIGIN=https://havenstudy.com,https://www.havenstudy.com" >> backend/.env.production
              fi
              
              # Update FRONTEND_URL for email links
              if grep -q "^FRONTEND_URL=" backend/.env.production; then
                sed -i 's|^FRONTEND_URL=.*|FRONTEND_URL=https://havenstudy.com|' backend/.env.production
              else
                echo "FRONTEND_URL=https://havenstudy.com" >> backend/.env.production
              fi
              
              # Ensure email is enabled
              if grep -q "^ENABLE_EMAIL=" backend/.env.production; then
                sed -i 's|^ENABLE_EMAIL=.*|ENABLE_EMAIL=true|' backend/.env.production
              else
                echo "ENABLE_EMAIL=true" >> backend/.env.production
              fi
              
              echo "âœ“ Production environment configured"
            fi
            
            echo "ğŸ§¹ Clearing caches..."
            docker compose down frontend backend || true
            docker builder prune -f || true
            docker system prune -f || true
            
            echo "ğŸ”¨ Rebuilding containers from scratch..."
            sed -i 's/npm ci/npm install/g' backend/Dockerfile
            docker compose build --no-cache backend frontend
            docker compose up -d backend frontend
            
            echo "â³ Waiting for services..."
            sleep 20
            
            echo "ğŸ¥ Health check..."
            curl -sf http://localhost:3001/health
            
            echo "ğŸŒ± Running database seeders (admin user)..."
            docker compose exec -T backend npm run seed || echo "Seeder skipped or already run"
            
            docker image prune -f
            echo "âœ… Deployment successful!"

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Haven Institute deployed successfully to https://havenstudy.com"
          else
            echo "âŒ Deployment failed! Check the logs above."
            exit 1
          fi
