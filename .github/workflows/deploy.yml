# Haven Institute - GitHub Actions CI/CD for Hetzner
# Auto-deploys on push to main branch

name: Deploy to Hetzner

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger option

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Hetzner VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e
            echo "üöÄ Starting deployment..."
            
            cd ~/apps/Haveninstitute
            
            # Pull latest changes
            echo "üì• Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Fix Dockerfile for npm install
            sed -i 's/npm ci/npm install/g' backend/Dockerfile
            
            # Rebuild and restart services
            echo "üî® Rebuilding containers..."
            docker compose up -d --build --force-recreate
            
            # Wait for services to start
            echo "‚è≥ Waiting for services to start..."
            sleep 15
            
            # Health check
            echo "üè• Running health check..."
            curl -sf http://localhost:3001/api/v1/health || exit 1
            
            # Clean up old images
            docker image prune -f
            
            echo "‚úÖ Deployment successful!"

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Haven Institute deployed successfully to https://havenstudy.com"
          else
            echo "‚ùå Deployment failed! Check the logs above."
            exit 1
          fi
