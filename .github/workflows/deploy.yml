# Haven Institute - GitHub Actions CI/CD for Hetzner
# Auto-deploys on push to main branch

name: Deploy to Hetzner

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger option

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Hetzner VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            cd ~/apps/Haveninstitute
            
            echo "üì• Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "üîß Ensuring CORS configuration..."
            if [ -f backend/.env.production ]; then
              # Update CORS_ORIGIN if it exists, otherwise add it
              if grep -q "^CORS_ORIGIN=" backend/.env.production; then
                sed -i 's|^CORS_ORIGIN=.*|CORS_ORIGIN=https://havenstudy.com,https://www.havenstudy.com|' backend/.env.production
              else
                echo "CORS_ORIGIN=https://havenstudy.com,https://www.havenstudy.com" >> backend/.env.production
              fi
              echo "‚úì CORS configured for production"
            fi
            
            echo "üî® Rebuilding containers..."
            sed -i 's/npm ci/npm install/g' backend/Dockerfile
            docker compose up -d --build backend frontend
            
            echo "‚è≥ Waiting for services..."
            sleep 20
            
            echo "üè• Health check..."
            curl -sf http://localhost:3001/health
            
            docker image prune -f
            echo "‚úÖ Deployment successful!"

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Haven Institute deployed successfully to https://havenstudy.com"
          else
            echo "‚ùå Deployment failed! Check the logs above."
            exit 1
          fi
