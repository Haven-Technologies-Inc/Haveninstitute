# Haven Institute - GitHub Actions CI/CD for Hetzner
# Auto-deploys on push to main branch

name: Deploy to Hetzner

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger option

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Hetzner VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            # Try multiple possible paths for the application
            if [ -d ~/apps/Haveninstitute ]; then
              cd ~/apps/Haveninstitute
            elif [ -d ~/Haveninstitute ]; then
              cd ~/Haveninstitute
            elif [ -d /root/apps/Haveninstitute ]; then
              cd /root/apps/Haveninstitute
            else
              echo "âŒ Application directory not found!"
              exit 1
            fi

            echo "ğŸ“ Working directory: $(pwd)"

            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "ğŸ—‘ï¸ Cleaning up unnecessary files on server..."
            # Remove documentation files (keep README.md)
            rm -f *.sql 2>/dev/null || true
            rm -f gen-hash.js register-admin.json 2>/dev/null || true
            rm -f .env.docker .env.staging .env.production.example 2>/dev/null || true
            rm -rf src/*.md src/guidelines 2>/dev/null || true
            rm -f backend/.env.production.example backend/.env.staging 2>/dev/null || true
            echo "âœ“ Server files cleaned"

            echo "ğŸ“ Ensuring database init directory exists..."
            mkdir -p database/init
            # Copy schema from multiple possible sources
            if [ -f database/init/01_schema.mariadb ]; then
              cp database/init/01_schema.mariadb database/init/01_schema.sql
              echo "âœ“ Database schema copied from .mariadb file"
            elif [ -f backend/src/database/schema.sql ]; then
              cp backend/src/database/schema.sql database/init/01_schema.sql
              echo "âœ“ Database schema copied from backend"
            fi

            echo "ğŸ”§ Ensuring production configuration..."
            # Create .env if it doesn't exist
            if [ ! -f .env ]; then
              if [ -f .env.production.template ]; then
                cp .env.production.template .env
                echo "âš ï¸ Created .env from template - configure secrets!"
              elif [ -f .env.example ]; then
                cp .env.example .env
                echo "âš ï¸ Created .env from example - configure secrets!"
              fi
            fi

            if [ -f backend/.env.production ]; then
              # Update CORS_ORIGIN
              if grep -q "^CORS_ORIGIN=" backend/.env.production; then
                sed -i 's|^CORS_ORIGIN=.*|CORS_ORIGIN=https://havenstudy.com,https://www.havenstudy.com|' backend/.env.production
              else
                echo "CORS_ORIGIN=https://havenstudy.com,https://www.havenstudy.com" >> backend/.env.production
              fi

              # Update FRONTEND_URL for email links
              if grep -q "^FRONTEND_URL=" backend/.env.production; then
                sed -i 's|^FRONTEND_URL=.*|FRONTEND_URL=https://havenstudy.com|' backend/.env.production
              else
                echo "FRONTEND_URL=https://havenstudy.com" >> backend/.env.production
              fi

              # Ensure email is enabled
              if grep -q "^ENABLE_EMAIL=" backend/.env.production; then
                sed -i 's|^ENABLE_EMAIL=.*|ENABLE_EMAIL=true|' backend/.env.production
              else
                echo "ENABLE_EMAIL=true" >> backend/.env.production
              fi

              echo "âœ“ Production environment configured"
            fi

            echo "ğŸ§¹ Clearing caches..."
            docker compose down frontend backend || true
            docker builder prune -f || true
            docker system prune -f || true

            echo "ğŸ”¨ Rebuilding containers from scratch..."
            sed -i 's/npm ci/npm install/g' backend/Dockerfile
            docker compose build --no-cache backend frontend
            docker compose up -d

            echo "â³ Waiting for services to start..."
            sleep 30

            echo "ğŸ¥ Health check (backend API)..."
            # Try the correct API health endpoint
            if curl -sf http://localhost:3001/api/v1/health > /dev/null 2>&1; then
              echo "âœ… Backend health check passed"
            elif curl -sf http://localhost:3001/health > /dev/null 2>&1; then
              echo "âœ… Backend health check passed (root endpoint)"
            else
              echo "âš ï¸ Backend health check failed - checking container logs..."
              docker compose logs --tail=50 backend
              # Don't exit - let's try to continue
            fi

            echo "ğŸŒ± Running database migrations and seeders..."
            docker compose exec -T backend npm run db:migrate 2>/dev/null || echo "Migrations skipped"
            docker compose exec -T backend npm run seed 2>/dev/null || echo "Seeder skipped or already run"

            docker image prune -f

            echo "ğŸ“Š Final status:"
            docker compose ps
            echo "âœ… Deployment completed!"

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Haven Institute deployed successfully to https://havenstudy.com"
          else
            echo "âŒ Deployment failed! Check the logs above."
            exit 1
          fi
